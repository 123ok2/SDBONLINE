<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PTDTBT THCS THU C√öC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" href="styles.css"> 
    <style>
        /* --- C·∫§U H√åNH CHUNG --- */
        body { background-color: #f2f5f8; -webkit-tap-highlight-color: transparent; }
        
        /* --- MARQUEE --- */
        #marquee-container { flex-grow: 1; margin: 0 2rem; height: 30px; overflow: hidden; white-space: nowrap; display: flex; align-items: center; }
        #marquee-text { display: inline-block; animation: marquee-motion 60s linear infinite; padding-left: 100%; }
        @keyframes marquee-motion { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        @media (max-width: 768px) { #marquee-container { display: none; } }

        /* --- NAVBAR --- */
        .navbar-top { position: fixed; top: 0; left: 0; right: 0; z-index: 40; background-color: white; box-shadow: 0 1px 10px rgba(0, 0, 0, 0.08); padding: 0; }
        .branding-strip { background-color: #031caa; color: white; padding: 0.5rem 1rem; display: flex; align-items: center; justify-content: space-between; height: 60px; }

        /* --- MENU DESKTOP (FIXED) --- */
        .menu-wrapper { display: flex; align-items: center; justify-content: flex-start; padding: 0 2rem; border-bottom: 2px solid #e2e8f0; position: relative; z-index: 45; }
        .menu-nav { display: flex; white-space: nowrap; width: max-content; }
        
        .menu-item, .menu-item-label { padding: 0.75rem 1rem; display: flex; align-items: center; cursor: pointer; transition: all 0.2s; white-space: nowrap; font-weight: 500; color: #000; }
        .menu-item:hover, .menu-item.active, .menu-item-dropdown:hover .menu-item-label { background-color: #fef2f2; color: #ef4444; }
        .menu-item.active, .menu-item-dropdown.active .menu-item-label { font-weight: 700; color: #ef4444; }
        
        /* DROPDOWN LOGIC (QUAN TR·ªåNG) */
        .menu-item-dropdown { position: relative; height: 100%; }
        
        .dropdown-content {
            display: none; position: absolute; top: 100%; left: 0; background-color: white;
            min-width: 240px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 50;
            border: 1px solid #e2e8f0; border-radius: 0 0 8px 8px; animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* FIX: Cho ph√©p Hover tr√™n PC */
        @media (min-width: 768px) {
            .menu-item-dropdown:hover .dropdown-content { display: block; }
            .menu-item-dropdown:hover ion-icon[name="chevron-down-outline"] { transform: rotate(180deg); transition: 0.3s; }
        }
        
        /* Class open d√πng cho JS toggle */
        .menu-item-dropdown.open .dropdown-content { display: block; }
        
        .dropdown-item { padding: 12px 20px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; color: #333; }
        .dropdown-item:hover { background-color: #fef2f2; color: #ef4444; padding-left: 25px; }

        /* --- MOBILE SIDEBAR --- */
        #mobile-sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background-color: white; z-index: 100; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 4px 0 25px rgba(0,0,0,0.15); overflow-y: auto; }
        #mobile-sidebar.open { transform: translateX(0); }
        #mobile-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(2px); }
        #mobile-overlay.open { opacity: 1; visibility: visible; }
        
        .mobile-menu-item { padding: 14px 20px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; font-weight: 500; color: #374151; transition: background 0.2s; }
        .mobile-menu-item:active { background-color: #fee2e2; }
        .mobile-menu-group-header { padding: 14px 20px; background-color: #fff; font-weight: 600; color: #111827; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f3f4f6; }
        .mobile-sub-menu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; background-color: #f9fafb; }
        .mobile-sub-menu.open { max-height: 500px; }
        .mobile-sub-menu .mobile-menu-item { padding-left: 35px; border-bottom: 1px dashed #e5e7eb; font-size: 0.95rem; color: #4b5563; }

        /* --- USER POPUP --- */
        .user-profile-dropdown { position: relative; }
        .info-box-dropdown {
            position: absolute; right: 0; top: 120%; width: 300px; background: white; border-radius: 12px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.3); z-index: 60; border: 1px solid #e5e7eb;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); opacity: 0; transform: scale(0.95); pointer-events: none; visibility: hidden;
        }
        .info-box-dropdown.show { opacity: 1; transform: scale(1); pointer-events: auto; visibility: visible; top: 110%; }
        @media (max-width: 640px) {
            .info-box-dropdown { position: fixed; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) scale(0.9) !important; width: 90%; max-width: 350px; margin: 0; right: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
            .info-box-dropdown.show { transform: translate(-50%, -50%) scale(1) !important; }
            .info-box-dropdown.show::before { content: ''; position: fixed; inset: -1000px; background: rgba(0,0,0,0.5); z-index: -1; }
        }

        /* --- MAIN CONTENT --- */
        .main-content-wrapper { padding-top: 70px; padding-bottom: 2rem; flex: 1; }
        @media (min-width: 768px) { .main-content-wrapper { padding-top: 8rem; padding-left: 2rem; padding-right: 2rem; } }
        .main-content-area { min-height: calc(100vh - 10rem); border-radius: 0.75rem; padding: 1rem; overflow-x: hidden; }
        .table-responsive-fix { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 1rem; border-radius: 8px; border: 1px solid #e5e7eb; }
        .date-input-group-fix { display: flex; flex-direction: column; gap: 0.5rem; }
        @media (min-width: 768px) { .date-input-group-fix { flex-direction: row; align-items: center; } }
        .fullscreen-modal { transition: opacity 0.3s, visibility 0.3s; opacity: 0; visibility: hidden; }
        .fullscreen-modal.show { opacity: 1; visibility: visible; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <header class="navbar-top"> 
        <div class="branding-strip">
            <div class="flex items-center">
                <button onclick="toggleMobileSidebar()" class="mr-3 text-white text-3xl md:hidden focus:outline-none"><ion-icon name="menu-outline"></ion-icon></button>
                <ion-icon name="book-outline" class="text-3xl mr-3 hidden md:block"></ion-icon> 
                <div class="flex flex-col items-start">
                     <div class="hidden md:block text-sm font-bold text-white uppercase" id="header-school-name-display">ƒêang t·∫£i...</div>
                    <span class="text-xs md:text-sm font-extrabold tracking-wide uppercase text-yellow-300">S·ªï ƒê·∫ßu B√†i Online</span>
                </div>
            </div>
            <div id="marquee-container"><p id="marquee-text" class="text-lg font-medium tracking-wide text-red-100"></p></div>
            <div class="user-profile-dropdown">
                <button id="user-info-button" onclick="toggleUserDropdown()" class="flex items-center bg-red-700 hover:bg-red-600 text-white p-1 pl-3 pr-1 md:p-2 md:pl-4 rounded-full transition shadow-md border border-red-500">
                    <span id="user-info-name-short" class="font-semibold text-sm mr-1">...</span><ion-icon name="person-circle-outline" class="text-3xl"></ion-icon>
                </button>
                <div id="user-dropdown-content" class="info-box-dropdown"> 
                    <button onclick="toggleUserDropdown()" class="absolute top-2 right-2 text-white md:hidden z-10 p-1"><ion-icon name="close-circle" class="text-2xl"></ion-icon></button>
                    <div class="px-5 pt-5 pb-4 bg-gradient-to-br from-red-800 to-red-900 text-white relative overflow-hidden">
                        <div class="flex items-center justify-between relative z-10"><div id="user-info-name" class="font-bold text-xl truncate pr-2">ƒêang t·∫£i...</div></div>
                        <div id="user-info-email" class="text-xs text-red-200 truncate mt-1 relative z-10">...</div>
                        <div class="mt-3 inline-block bg-green-500/20 border border-green-400/50 rounded px-2 py-0.5 text-[10px] font-bold tracking-wider text-green-100">GI√ÅO VI√äN</div>
                    </div>
                    <div class="px-5 py-4 bg-white"> 
                        <div class="space-y-3">
                            <div id="user-info-subject" class="flex justify-between items-center text-sm border-b border-dashed pb-2"><span class="text-gray-500 font-medium">M√¥n d·∫°y</span><span class="font-bold text-gray-800">...</span></div>
                            <div id="user-info-school" class="flex justify-between items-start text-sm"><span class="text-gray-500 font-medium whitespace-nowrap mr-2">ƒê∆°n v·ªã</span><span class="font-bold text-gray-800 text-right text-xs leading-tight">...</span></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 grid grid-cols-2 gap-3">
                        <button onclick="document.getElementById('contact-modal').classList.add('show'); toggleUserDropdown();" class="flex flex-col items-center justify-center py-2 bg-white border rounded-lg shadow-sm hover:bg-gray-50 transition"><ion-icon name="help-buoy-outline" class="text-2xl text-blue-600 mb-1"></ion-icon><span class="text-xs font-semibold text-gray-600">H·ªó tr·ª£</span></button>
                        <button onclick="handleLogout()" class="flex flex-col items-center justify-center py-2 bg-red-50 border border-red-100 rounded-lg shadow-sm hover:bg-red-100 transition"><ion-icon name="log-out-outline" class="text-2xl text-red-600 mb-1"></ion-icon><span class="text-xs font-bold text-red-600">ƒêƒÉng xu·∫•t</span></button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="menu-wrapper hidden md:flex">
            <nav class="menu-nav"> 
                <div id="menu-group-1" class="menu-item-dropdown" onclick="toggleMenuDropdown(event, this)">
                    <div class="menu-item-label"><ion-icon name="calendar-outline" class="text-lg mr-2"></ion-icon> Qu·∫£n l√Ω TKB <ion-icon name="chevron-down-outline" class="ml-1 text-xs opacity-60"></ion-icon></div>
                    <div class="dropdown-content">
                        <div id="menu-1" class="dropdown-item" onclick="loadContent('menu1_tkb.html', this, 'menu-group-1')"><ion-icon name="create-outline" class="mr-2 text-blue-500"></ion-icon> Nh·∫≠p TKB C√° Nh√¢n</div>
                        <div id="menu-9" class="dropdown-item" onclick="loadContent('menu9_tra_cuu.html', this, 'menu-group-1')"><ion-icon name="search-outline" class="mr-2 text-purple-500"></ion-icon> Tra C·ª©u TKB</div>
                    </div>
                </div>
                <div id="menu-group-2" class="menu-item-dropdown" onclick="toggleMenuDropdown(event, this)">
                    <div class="menu-item-label"><ion-icon name="book-outline" class="text-lg mr-2"></ion-icon> S·ªï ƒê·∫ßu B√†i <ion-icon name="chevron-down-outline" class="ml-1 text-xs opacity-60"></ion-icon></div>
                    <div class="dropdown-content">
                        <div id="menu-2" class="dropdown-item" onclick="loadContent('menu2_sdb.html', this, 'menu-group-2')"><ion-icon name="pencil-outline" class="mr-2 text-green-500"></ion-icon> Ghi S·ªï ƒê·∫ßu B√†i</div>
                        <div id="menu-3" class="dropdown-item" onclick="loadContent('menu3_history.html', this, 'menu-group-2')"><ion-icon name="time-outline" class="mr-2 text-orange-500"></ion-icon> L·ªãch S·ª≠ Ghi</div>
                    </div>
                </div>
                 <div id="menu-group-4" class="menu-item-dropdown" onclick="toggleMenuDropdown(event, this)">
                    <div class="menu-item-label"><ion-icon name="stats-chart-outline" class="text-lg mr-2"></ion-icon> B√°o C√°o <ion-icon name="chevron-down-outline" class="ml-1 text-xs opacity-60"></ion-icon></div>
                    <div class="dropdown-content">
                        <div id="menu-4" class="dropdown-item" onclick="loadContent('menu4_report.html', this, 'menu-group-4')"><ion-icon name="person-outline" class="mr-2 text-teal-500"></ion-icon> B√°o C√°o C√° Nh√¢n</div>
                        <div id="menu-7" class="dropdown-item" onclick="loadContent('menu7_admin_report.html', this, 'menu-group-4')"><ion-icon name="school-outline" class="mr-2 text-red-500"></ion-icon> B√°o C√°o To√†n Tr∆∞·ªùng</div>
                    </div>
                </div>
                <div id="menu-5" class="menu-item" onclick="loadContent('menu5_class_sdb.html', this)"><ion-icon name="grid-outline" class="text-lg mr-2"></ion-icon> SƒêB Theo L·ªõp</div>
                <div id="menu-6" class="menu-item" onclick="loadContent('menu6_ranking.html', this)"><ion-icon name="trophy-outline" class="text-lg mr-2"></ion-icon> X·∫øp H·∫°ng</div>
                <div id="menu-8" class="menu-item" onclick="loadContent('huong_dan_su_dung.html', this)"><ion-icon name="information-circle-outline" class="text-lg mr-2"></ion-icon> H∆∞·ªõng d·∫´n</div>
            </nav>
        </div>
    </header>

    <div id="mobile-overlay" onclick="toggleMobileSidebar()"></div>
    <div id="mobile-sidebar">
        <div class="h-[60px] bg-[#031caa] text-white font-bold flex items-center justify-between px-4 shadow-md">
            <span class="flex items-center"><ion-icon name="apps-outline" class="mr-2 text-xl"></ion-icon> DANH M·ª§C</span>
            <button onclick="toggleMobileSidebar()" class="p-1"><ion-icon name="close-outline" class="text-2xl"></ion-icon></button>
        </div>
        <div class="py-2">
            <div class="mobile-menu-group-header" onclick="toggleMobileSubMenu('mob-sub-1', this)"><span class="flex items-center"><ion-icon name="calendar-outline" class="mr-3 text-blue-600"></ion-icon> Qu·∫£n l√Ω TKB</span><ion-icon name="chevron-down-outline" class="transition-transform duration-300"></ion-icon></div>
            <div id="mob-sub-1" class="mobile-sub-menu">
                <div class="mobile-menu-item" onclick="loadContent('menu1_tkb.html'); toggleMobileSidebar()">Nh·∫≠p TKB C√° Nh√¢n</div>
                <div class="mobile-menu-item" onclick="loadContent('menu9_tra_cuu.html'); toggleMobileSidebar()">Tra C·ª©u TKB</div>
            </div>
            <div class="mobile-menu-group-header" onclick="toggleMobileSubMenu('mob-sub-2', this)"><span class="flex items-center"><ion-icon name="create-outline" class="mr-3 text-green-600"></ion-icon> S·ªï ƒê·∫ßu B√†i</span><ion-icon name="chevron-down-outline" class="transition-transform duration-300"></ion-icon></div>
            <div id="mob-sub-2" class="mobile-sub-menu">
                <div class="mobile-menu-item" onclick="loadContent('menu2_sdb.html'); toggleMobileSidebar()">Ghi S·ªï ƒê·∫ßu B√†i</div>
                <div class="mobile-menu-item" onclick="loadContent('menu3_history.html'); toggleMobileSidebar()">L·ªãch S·ª≠ Ghi</div>
            </div>
             <div class="mobile-menu-group-header" onclick="toggleMobileSubMenu('mob-sub-4', this)"><span class="flex items-center"><ion-icon name="stats-chart-outline" class="mr-3 text-orange-600"></ion-icon> B√°o C√°o</span><ion-icon name="chevron-down-outline" class="transition-transform duration-300"></ion-icon></div>
            <div id="mob-sub-4" class="mobile-sub-menu">
                <div class="mobile-menu-item" onclick="loadContent('menu4_report.html'); toggleMobileSidebar()">B√°o C√°o C√° Nh√¢n</div>
                <div class="mobile-menu-item" onclick="loadContent('menu7_admin_report.html'); toggleMobileSidebar()">B√°o C√°o To√†n Tr∆∞·ªùng</div>
            </div>
            <div class="mobile-menu-item" onclick="loadContent('menu5_class_sdb.html'); toggleMobileSidebar()"><ion-icon name="grid-outline" class="mr-3 text-teal-600"></ion-icon> SƒêB Theo L·ªõp</div>
            <div class="mobile-menu-item" onclick="loadContent('menu6_ranking.html'); toggleMobileSidebar()"><ion-icon name="trophy-outline" class="mr-3 text-yellow-500"></ion-icon> X·∫øp H·∫°ng GV</div>
            <div class="mobile-menu-item" onclick="loadContent('huong_dan_su_dung.html'); toggleMobileSidebar()"><ion-icon name="information-circle-outline" class="mr-3 text-gray-500"></ion-icon> H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</div>
        </div>
    </div>

    <main class="main-content-wrapper">
        <div id="main-content" class="bg-white rounded-xl shadow-sm border border-gray-100 main-content-area"> 
            <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                <ion-icon name="cloud-download-outline" class="text-4xl mb-2 animate-bounce"></ion-icon><span class="text-sm font-medium">ƒêang t·∫£i d·ªØ li·ªáu...</span>
            </div>
        </div>
    </main>

    <div id="contact-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[70] fullscreen-modal backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-zoomIn">
            <div class="bg-indigo-600 p-4 flex justify-between items-center text-white"><h2 class="text-lg font-bold flex items-center"><ion-icon name="headset-outline" class="mr-2"></ion-icon> Li√™n h·ªá h·ªó tr·ª£</h2><button onclick="document.getElementById('contact-modal').classList.remove('show')" class="text-white/80 hover:text-white"><ion-icon name="close" class="text-2xl"></ion-icon></button></div>
            <div class="p-5 space-y-4">
                <a href="tel:0868640898" class="flex items-center p-3 bg-gray-50 rounded-xl hover:bg-blue-50 transition border border-gray-100"><div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3"><ion-icon name="call" class="text-xl"></ion-icon></div><div><div class="text-xs text-gray-500 font-bold uppercase">Hotline</div><div class="text-gray-800 font-bold">0868.640.898</div></div></a>
                <a href="mailto:duyconghanh2017@gmail.com" class="flex items-center p-3 bg-gray-50 rounded-xl hover:bg-red-50 transition border border-gray-100"><div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center mr-3"><ion-icon name="mail" class="text-xl"></ion-icon></div><div><div class="text-xs text-gray-500 font-bold uppercase">Email</div><div class="text-gray-800 font-bold truncate max-w-[180px]">duyconghanh2017@gmail.com</div></div></a>
                <a href="https://facebook.com/1994duyhanh" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-xl hover:bg-indigo-50 transition border border-gray-100"><div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center mr-3"><ion-icon name="logo-facebook" class="text-xl"></ion-icon></div><div><div class="text-xs text-gray-500 font-bold uppercase">Facebook</div><div class="text-gray-800 font-bold">Duy H·∫°nh</div></div></a>
            </div>
            <div class="p-4 bg-gray-50 border-t text-center"><button onclick="document.getElementById('contact-modal').classList.remove('show')" class="text-gray-500 font-semibold hover:text-gray-800 text-sm">ƒê√≥ng c·ª≠a s·ªï</button></div>
        </div>
    </div>
    
    <div id="greeting-popup" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[70] fullscreen-modal backdrop-blur-sm px-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center relative overflow-hidden">
             <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
            <ion-icon name="sparkles" class="text-5xl text-yellow-400 mb-3"></ion-icon><h2 id="greeting-title" class="text-xl font-bold text-gray-800 mb-2">Xin ch√†o!</h2><p id="greeting-message" class="text-gray-600 mb-6 text-sm leading-relaxed"></p>
            <button onclick="document.getElementById('greeting-popup').classList.remove('show')" class="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform active:scale-95 transition">B·∫Øt ƒë·∫ßu l√†m vi·ªác</button>
        </div>
    </div>
    
    <div id="onboarding-popup" class="fixed inset-0 bg-white z-[80] fullscreen-modal flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-md">
            <div class="text-center mb-8"><div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600"><ion-icon name="person-add" class="text-4xl"></ion-icon></div><h2 class="text-2xl font-bold text-gray-900">C·∫≠p nh·∫≠t h·ªì s∆°</h2><p class="text-gray-500 text-sm mt-2">Vui l√≤ng cung c·∫•p th√¥ng tin ƒë·ªÉ h·ªá th·ªëng ghi nh·∫≠n ch√≠nh x√°c.</p></div>
            <form id="onboarding-form" class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† T√™n</label><input type="text" id="ho-ten" required placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">M√¥n Gi·∫£ng D·∫°y</label><input type="text" id="mon-hoc" required placeholder="V√≠ d·ª•: To√°n, KHTN..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">ƒê∆°n v·ªã c√¥ng t√°c</label><input type="text" id="truong-hoc" required value="PTDTBT THCS THU C√öC" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"></div>
                <button type="submit" id="save-profile-button" class="w-full py-3.5 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg mt-4 transition">Ho√†n t·∫•t & Ti·∫øp t·ª•c</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDLkqxwvJHVzB_PhsYWnI2R8yWe4kyRwJ8", authDomain: "okok-d34a7.firebaseapp.com", projectId: "okok-d34a7", storageBucket: "okok-d34a7.firebasestorage.app", messagingSenderId: "131453877704", appId: "1:131453877704:web:62b32f9e9cab317e2194fd", measurementId: "G-0M1XEXL9K6" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); 
        const mainContent = document.getElementById('main-content');
        let currentUserId = null;

        // --- MENU LOGIC (DESKTOP & MOBILE) ---
        window.toggleMobileSidebar = () => {
            document.getElementById('mobile-sidebar').classList.toggle('open');
            document.getElementById('mobile-overlay').classList.toggle('open');
        }
        
        window.toggleMobileSubMenu = (id, headerElement) => {
            const sub = document.getElementById(id);
            const icon = headerElement.querySelector('ion-icon[name="chevron-down-outline"]');
            if(sub.classList.contains('open')) { sub.classList.remove('open'); icon.style.transform = 'rotate(0deg)'; } 
            else { document.querySelectorAll('.mobile-sub-menu').forEach(el => el.classList.remove('open')); document.querySelectorAll('.mobile-menu-group-header ion-icon[name="chevron-down-outline"]').forEach(el => el.style.transform = 'rotate(0deg)'); sub.classList.add('open'); icon.style.transform = 'rotate(180deg)'; }
        }

        // FIX: Toggle Dropdown cho PC (Click logic)
        window.toggleMenuDropdown = function(event, element) {
            if(event) event.stopPropagation();
            document.querySelectorAll('.menu-item-dropdown').forEach(item => { if (item !== element) item.classList.remove('open'); });
            element.classList.toggle('open');
        }
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.menu-item-dropdown')) { document.querySelectorAll('.menu-item-dropdown').forEach(item => item.classList.remove('open')); }
        });

        // --- USER DROPDOWN ---
        window.toggleUserDropdown = () => document.getElementById('user-dropdown-content').classList.toggle('show');
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown-content');
            const button = document.getElementById('user-info-button');
            if (dropdown.classList.contains('show') && !dropdown.contains(event.target) && !button.contains(event.target)) dropdown.classList.remove('show');
        });

        // --- LOAD CONTENT ---
        window.loadContent = async function(pageUrl, clickedElement, parentGroupId = null) {
            if(clickedElement) {
                document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                document.querySelectorAll('.menu-item-dropdown').forEach(item => item.classList.remove('active'));
                if (parentGroupId) { const parentGroup = document.getElementById(parentGroupId); if(parentGroup) { parentGroup.classList.add('active'); parentGroup.classList.remove('open'); } } 
                else { clickedElement.classList.add('active'); }
            }
            mainContent.innerHTML = `<div class="animate-pulse p-4 space-y-4"><div class="h-8 bg-gray-200 rounded w-1/3"></div><div class="h-32 bg-gray-100 rounded"></div></div>`;
            try {
                const response = await fetch(pageUrl);
                if (!response.ok) throw new Error("Error");
                let content = await response.text();
                // CSS Fix injection
                if (content.includes('<table')) { content = content.replace(/<table/g, '<div class="table-responsive-fix"><table').replace(/<\/table>/g, '</table></div>'); }
                content = content.replace(/flex items-center space-x-4/g, 'date-input-group-fix').replace(/flex items-center/g, 'date-input-group-fix');
                mainContent.innerHTML = content;
                setTimeout(() => {
                    if (window.appLogic) {
                        const logicMap = { 'menu1_tkb.html': 'initMenu1', 'menu9_tra_cuu.html': 'initMenu9', 'menu2_sdb.html': 'initMenu2', 'menu3_history.html': 'initMenu3', 'menu4_report.html': 'initMenu4', 'menu7_admin_report.html': 'initMenu7', 'menu5_class_sdb.html': 'initMenu5', 'menu6_ranking.html': 'initMenu6' };
                        if(logicMap[pageUrl]) window.appLogic[logicMap[pageUrl]]();
                    }
                }, 50);
            } catch (error) { mainContent.innerHTML = `<div class="text-center p-10 text-red-500"><ion-icon name="alert-circle" class="text-4xl"></ion-icon><p>Kh√¥ng t·∫£i ƒë∆∞·ª£c n·ªôi dung.</p></div>`; }
        }
        
        // --- AUTH ---
        async function loadUserInfo(userId) {
            const profileRef = doc(db, "users", userId, "profile", "data");
            try {
                const docSnap = await getDoc(profileRef);
                const defaultName = "Gi√°o vi√™n";
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('user-info-name').textContent = data.hoTen || defaultName;
                    document.getElementById('user-info-name-short').textContent = (data.hoTen || defaultName).split(' ').pop();
                    document.getElementById('user-info-email').textContent = auth.currentUser.email;
                    const subEl = document.querySelector('#user-info-subject span:last-child');
                    const schEl = document.querySelector('#user-info-school span:last-child');
                    if(subEl) subEl.textContent = data.monHoc || "...";
                    if(schEl) schEl.textContent = data.truongHoc || "THCS Thu C√∫c";
                    document.getElementById('header-school-name-display').textContent = data.truongHoc || "THCS THU C√öC";
                    return data.hoTen;
                }
                return defaultName;
            } catch (e) { return "Gi√°o vi√™n"; }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                if (window.appLogic && window.appLogic.setLogicUserId) window.appLogic.setLogicUserId(currentUserId);
                const profileRef = doc(db, "users", currentUserId, "profile", "data");
                const docSnap = await getDoc(profileRef);
                if (!docSnap.exists() || !docSnap.data().hoTen) { document.getElementById('onboarding-popup').classList.add('show'); } 
                else {
                    const name = await loadUserInfo(currentUserId);
                    const hour = new Date().getHours();
                    const greeting = hour < 12 ? "Ch√†o bu·ªïi s√°ng" : (hour < 18 ? "Ch√†o bu·ªïi chi·ªÅu" : "Ch√†o bu·ªïi t·ªëi");
                    document.getElementById('greeting-title').textContent = `${greeting}, ${name}!`;
                    document.getElementById('greeting-message').textContent = "Ch√∫c b·∫°n m·ªôt ng√†y l√†m vi·ªác hi·ªáu qu·∫£.";
                    document.getElementById('greeting-popup').classList.add('show');
                }
                loadContent('menu1_tkb.html', document.getElementById('menu-1'), 'menu-group-1');
            } else { window.location.href = "login_page.html"; }
        });

        window.handleLogout = async () => { try { await signOut(auth); } catch(e) {} }
        document.getElementById('onboarding-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-profile-button'); btn.disabled = true; btn.textContent = "ƒêang l∆∞u...";
            try {
                const data = { hoTen: document.getElementById('ho-ten').value, monHoc: document.getElementById('mon-hoc').value, truongHoc: document.getElementById('truong-hoc').value };
                await setDoc(doc(db, "users", currentUserId, "profile", "data"), data, { merge: true });
                await setDoc(doc(db, "public_data", "user_list_doc"), { users: { [currentUserId]: data.hoTen } }, { merge: true });
                document.getElementById('onboarding-popup').classList.remove('show');
                loadUserInfo(currentUserId);
            } catch(e) {} finally { btn.disabled = false; btn.textContent = "Ho√†n t·∫•t"; }
        });
        
        const quotes = ["H·∫°nh ph√∫c c·ªßa th·∫ßy l√† s·ª± tr∆∞·ªüng th√†nh c·ªßa tr√≤.", "M·ªói ng√†y ƒë·∫øn tr∆∞·ªùng l√† m·ªôt ng√†y vui.", "T·∫≠n t√¢m, t·∫≠n l·ª±c, t·∫•t c·∫£ v√¨ h·ªçc sinh th√¢n y√™u."];
        setInterval(() => { const el = document.getElementById('marquee-text'); if(el) el.textContent = `üì¢ ${quotes[Math.floor(Math.random() * quotes.length)]}`; }, 30000);
        document.getElementById('marquee-text').textContent = `üì¢ ${quotes[0]}`;
    </script>
    <script type="module" src="app_logic.js"></script>
</body>
</html>
